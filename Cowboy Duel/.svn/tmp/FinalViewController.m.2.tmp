//
//  FinalViewController.m
//  Test
//
//  Created by Sobol on 23.05.11.
//  Copyright 2011 __MyCompanyName__. All rights reserved.
//

#import "FinalViewController.h"
//#import "BluetoothViewController.h"
#import "TeachingViewController.h"
#import "GameCenterViewController.h"
#import "StartViewController.h"
#import "AdColonyViewController.h"
#import "ProfileViewController.h"
#import "GCHelper.h"
#import "DuelRewardLogicController.h"
#import "AdvertisingAppearController.h"

@interface FinalViewController (PrivateMethods)

-(void)winScene;
-(void)loseScene;
-(void)lastScene;
-(void)showMoneyLable;
-(void)checkMaxWin:(int)moneyExch;
-(void)increaseLoseCount;
-(void)increaseWinCount;

@end

#define TAG_TEXT 1002

@implementation FinalViewController

static const char *DUEL_RES_URL = BASE_URL"api/duel_result";

//static const NSString *stGABT = @"/duel/";
//static const NSString *stGAT = @"/duel_teaching/";
//static const NSString *stGAGC = @"/duel_GS/";

@synthesize delegate;
@synthesize viewWin, lblWinEarned, lblWinGold, lblWinGoldCount, lblWinPoints, lblWinPointsCount;
@synthesize viewLose, lblLoseEarned, lblLoseLost, lblLoseGold, lblLoseGoldCount, lblLosePoints, lblLosePointsCount;
@synthesize statView;

-(id)initWithUserTime:(int)userTimePar andOponentTime:(int)oponentTime andController:(id)delegateController andTeaching:(BOOL)teach andAccount:(AccountDataSource *)userAccount andOpAccount:(AccountDataSource *)opAccount
{
    self = [super initWithNibName:@"FinalViewController" bundle:[NSBundle mainBundle]];

    if (self){
// added 
        NSURL *url = [NSURL fileURLWithPath:[NSString stringWithFormat:@"%@/cry.mp3", [[NSBundle mainBundle] resourcePath]]];
        follPlayer = [[AVAudioPlayer alloc] initWithContentsOfURL:url error:nil];
// above        
        
        NSUserDefaults *userDef = [NSUserDefaults standardUserDefaults];
        firstRun = ![userDef boolForKey:@"FirstRunForFinal"];
        [userDef setBool:YES forKey:@"FirstRunForFinal"];
        [userDef synchronize];
        
        reachNewLevel = NO;
        lastDuel = NO;
        runAway=NO;
        
        teaching = teach;
        playerAccount = userAccount;
        oponentAccount = opAccount;
        userTime=userTimePar;
        
        if (teaching&&(oponentAccount.accountName != NSLocalizedString(@"COMPUTER", @""))) {
            duelWithBotCheck=YES;
        }else{
            duelWithBotCheck=NO;
        }
        
        NSLog(@"Time final %d  %d",userTime,oponentTime);
        stGA=[[NSString alloc] init];
        
//        if ([delegateController isKindOfClass:[BluetoothViewController class]]){
//            stGA = @"/duel/";
//        }else 
        if([delegateController isKindOfClass:[TeachingViewController class]]){
            if (duelWithBotCheck) {
                stGA = @"/duel_BOT/";
            }else{
                stGA = @"/duel_teaching/";
            }
            teachingViewController = delegateController;
        }else if([delegateController isKindOfClass:[GameCenterViewController class]]){
            stGA = @"/duel_GS/";
        }  
        
        
        transaction = [[CDTransaction alloc] init];
        transaction.trMoneyCh = [NSNumber numberWithInt:10];
        
        
        transaction.trDescription = [[NSString alloc] initWithFormat:@"Duel"];
        
        duel = [[CDDuel alloc] init];
        duel.dOpponentId = [[NSString alloc] initWithFormat:@""];
      
        
        resoultDataSource = [[ResoultDataSource alloc] init];
        self.delegate = delegateController;
        
        NSLog(@"U %d O %d", userTime, oponentTime);
        
        if ((userTime != 0)&& (userTime != 999999.0) && (userTime < oponentTime)&& (oponentTime != 999999.0)) {
            [delegate increaseMutchNumberWin];
            // added               
            [follPlayer setVolume:0.2];
            // above               
            [delegate increaseMutchNumber];
            resoultDataSource.result = YES;
            
        }
        else
            if ((userTime == 0) && (oponentTime != 0) && (oponentTime != 999999.0)&& (userTime != 999999.0)) {
                [delegate increaseMutchNumberLose];
                [delegate increaseMutchNumber];
                resoultDataSource.result = NO;
              
            }
        
        if ((oponentTime != 0) && (oponentTime != 999999.0) && (userTime > oponentTime)&& (userTime != 999999.0)) {
            [delegate increaseMutchNumberLose];
            [delegate increaseMutchNumber];
            resoultDataSource.result = NO;              
        } 
        else
            if ((userTime != 0) && (userTime != 999999.0) && (oponentTime == 0)&& (oponentTime != 999999.0)) {
                [delegate increaseMutchNumberWin];
                // added               
                [follPlayer setVolume:0.2];
                // above               
                [delegate increaseMutchNumber];
                resoultDataSource.result = YES;
            }
        
        resoultDataSource.foll = NO;
        falseLabel =  NSLocalizedString(@"False", @"");
        foll = NO;
        
        if (userTime == 999999.0) {
            falseLabel = NSLocalizedString(@"False", @"") ;
            [delegate increaseMutchNumberLose];
            [delegate increaseMutchNumber];
            resoultDataSource.foll = YES;
            resoultDataSource.result = YES;
        }
        if (oponentTime == 999999.0){ 
            falseLabel =  NSLocalizedString(@"Falses", @"");
            [delegate increaseMutchNumberWin];
            // added               
            [follPlayer setVolume:0.2];
            // above               
            [delegate increaseMutchNumber];
            resoultDataSource.foll = YES;
            resoultDataSource.result = NO;
            NSLog(@"Oponent fouled");
        }
        
        fMutchNumberWin = [delegate fMutchNumberWin];
        NSLog(@"win %d",fMutchNumberWin);
        fMutchNumberLose = [delegate fMutchNumberLose];
        resoultDataSource.mutchNumber = [delegate fMutchNumber];
        resoultDataSource.deltaTime = userTime;
        resoultDataSource.UserTime= userTime;  
        
        [playerAccount.finalInfoTable addObject:resoultDataSource];
        
        if((resoultDataSource.mutchNumber!=3)&&(resoultDataSource.mutchNumber!=0)) {
            NSString *resultOfMutch;
            if (resoultDataSource.result) {
                
                if(!resoultDataSource.foll){
                    resultOfMutch=@"Win";
                }else{
                    resultOfMutch=@"Fouled_User";
                }
            }
            else {
                if(!resoultDataSource.foll){
                    resultOfMutch=@"Lost";
                }else{
                    resultOfMutch=@"Fouled_Oponent";
                }
                
            }
            
            [[NSNotificationCenter defaultCenter] postNotificationName:kAnalyticsTrackEventNotification 
                                                                object:self
                                                              userInfo:
             [NSDictionary dictionaryWithObject:[NSString stringWithFormat:@"%@match_%d(%@)",stGA,resoultDataSource.mutchNumber,resultOfMutch] forKey:@"event"]];
            
        }
        
        [player setNumberOfLoops:999];
        
        [follPlayer play];
        
        if (!lastDuel) {
            NSURL *url = [NSURL fileURLWithPath:[NSString stringWithFormat:@"%@/Back2.mp3", [[NSBundle mainBundle] resourcePath]]];
            NSError *error;
            player = [[AVAudioPlayer alloc] initWithContentsOfURL:url error:&error];
            [player play];
            [player stop];
        }
    }
    return self;
}

-(BOOL)shouldAutorotateToInterfaceOrientation:(UIInterfaceOrientation)interfaceOrientation
{
    return (interfaceOrientation == UIInterfaceOrientationPortrait);
}

-(void) viewDidLoad {
     
    [lblResulDescription setFont: [UIFont fontWithName: @"DecreeNarrow" size:30]];
       
    [tryButton setTitleByLabel:@"TRY"];
    UIColor *colorOfButtons=[UIColor colorWithRed:0.95 green:0.86 blue:0.68 alpha:1.0];
    [tryButton changeColorOfTitleByLabel:colorOfButtons];
    
    [nextButton setTitleByLabel:@"NEXTR"];
    if (lastDuel) nextButton.hidden = YES;
    else nextButton.hidden = NO;
    [nextButton changeColorOfTitleByLabel:colorOfButtons];
    
    [backButton setTitleByLabel:@"CANCEL_DUEL"];
    [backButton changeColorOfTitleByLabel:colorOfButtons ];
    
//    !!!!! Блять хто затер мою роботу??? Для кнопок з лейбами єсть методи setTitleByLabel,changeColorOfTitleByLabel,changeTitleByLabel
//    UIColor *btnColor = [UIColor colorWithRed:244.0f/255.0f green:222.0f/255.0f blue:176.0f/255.0f alpha:1.0f];
//    
//    lbBack.text = NSLocalizedString(@"CANCEL_DUEL", nil);
//    lbBack.textColor = btnColor;
//    lbBack.font = [UIFont fontWithName: @"DecreeNarrow" size:24];
//    
//    lbNextRound.text = NSLocalizedString(@"NEXTR", nil);
//    lbNextRound.textColor = btnColor;
//    lbNextRound.font = [UIFont fontWithName: @"DecreeNarrow" size:24];
//    
//    lbTryAgain.text = NSLocalizedString(@"TRY", nil);
//    lbTryAgain.textColor = btnColor;
//    lbTryAgain.font = [UIFont fontWithName: @"DecreeNarrow" size:24];
    
    resultTable.delegate = self;
    resultTable.dataSource = self;
    
    if (playerAccount.accountName != nil) lblNamePlayer.text = playerAccount.accountName;
    else lblNamePlayer.text = @"YOU";
    [lblNamePlayer setFont: [UIFont fontWithName: @"MyriadPro-Semibold" size:20]];
    lblNameOponnent.text = oponentAccount.accountName;
    
    [lblNameOponnent setFont: [UIFont fontWithName: @"MyriadPro-Semibold" size:20]];
    
    if (fMutchNumberWin == 2) {
        [self winScene];
    }
    if (fMutchNumberLose == 2) {
        [self loseScene];
    }

    if (lastDuel) {
        [self lastScene];
        [player play];
    }
    else {
        viewLastSceneAnimation.hidden=YES;
    }
    activityIndicatorView = [[ActivityIndicatorView alloc] init];
    
    CGRect frame=activityIndicatorView.frame;
    frame.origin=CGPointMake(-80, 0);
    activityIndicatorView.frame=frame;
    
    [self.view addSubview:activityIndicatorView];
}

-(void)viewWillAppear:(BOOL)animated
{    
    [activityIndicatorView hideView];
    
    if (firstRun) {
        firstRun = NO; 
    }
    else {
        [hudView setHidden:YES];
    }
    
    [statView setDinamicHeightBackground];
}

-(void)viewDidAppear:(BOOL)animated
{   
    
}

-(void)viewDidDisappear:(BOOL)animated
{
    [player stop];
}
#pragma mark -

-(IBAction)backButtonClick:(id)sender
{
    if (lastDuel) {
        NSUserDefaults *userDef = [NSUserDefaults standardUserDefaults];
        if (([userDef integerForKey:@"FirstRunForPractice"] != 1)&&([userDef integerForKey:@"FirstRunForPractice"] != 2)) {
            [userDef setInteger:1 forKey:@"FirstRunForPractice"];
            [userDef synchronize];
        }
        
        if(playerAccount.money<0) playerAccount.money=0;
        [[NSUserDefaults standardUserDefaults] setInteger:playerAccount.money forKey:@"money"];
        [self.navigationController popToViewController:[self.navigationController.viewControllers objectAtIndex:1] animated:YES];
//        if ([self.delegate isKindOfClass:[BluetoothViewController class]]) [self.delegate duelCancel];
        if ([self.delegate isKindOfClass:[GameCenterViewController class]]) {
            [self.delegate performSelector:@selector(matchCanseled)];
            
        }
        
        if (!teaching){
    //        appear advertising
            [AdvertisingAppearController advertisingCountIncrease];
        }
    }else{
        if (!teaching||duelWithBotCheck) {     
            fMutchNumberLose = 2;
            [self loseScene];
            [self lastScene];

            if ([delegate respondsToSelector:@selector(duelRunAway)])
                [delegate duelRunAway];
            
            runAway=YES;
            runAwayGood=NO;
            resoultDataSource = [[ResoultDataSource alloc] init];
            [playerAccount.finalInfoTable addObject:resoultDataSource];
            [resultTable reloadData];
            
            [[NSNotificationCenter defaultCenter] postNotificationName:kAnalyticsTrackEventNotification 
                                                                object:self
                                                              userInfo:[NSDictionary dictionaryWithObject:[NSString stringWithFormat:@"%@%@",stGA,@"run_away"] forKey:@"event"]];
            
            
        }else{
            [self.navigationController popToViewController:[self.navigationController.viewControllers objectAtIndex:1] animated:YES];
        }
    }
}

-(void)runAway
{
    NSLog(@"Run away oponent");
    fMutchNumberLose = 3;
    [self winScene];
    [self lastScene];
    runAway=YES;
    runAwayGood=YES;
    resoultDataSource = [[ResoultDataSource alloc] init];
    [playerAccount.finalInfoTable addObject:resoultDataSource];
    [resultTable reloadData];
}

-(IBAction)nextButtonClick:(id)sender
{
    NSLog(@"nextButtonClick");
    [activityIndicatorView showView];
    if(teaching)
    {
        if ((fMutchNumberWin != 2)&&(fMutchNumberLose != 2)) 
            [self.navigationController popViewControllerAnimated:YES];
    }
    else
    {
        if ([delegate respondsToSelector:@selector(nextDuelStart)])
        {
            [delegate nextDuelStart];
        }
    }
}

-(IBAction)tryButtonClick:(id)sender
{
    NSLog(@"tryButtonClick");

    [activityIndicatorView showView];
    
    if(teaching)
    {
        NSUserDefaults *userDef = [NSUserDefaults standardUserDefaults];
        if (([userDef integerForKey:@"FirstRunForPractice"] != 1)&&([userDef integerForKey:@"FirstRunForPractice"] != 2)) {
            [userDef setInteger:1 forKey:@"FirstRunForPractice"];
            [userDef synchronize];
        }

        [playerAccount.finalInfoTable removeAllObjects];
        teachingViewController.mutchNumber = 0;
        teachingViewController.mutchNumberWin = 0;
        teachingViewController.mutchNumberLose = 0;
        //                int randomTime = arc4random() % 6; 
        //                [self.navigationController.viewControllers objectAtIndex:1] = [[TeachingViewController alloc] initWithTime:randomTime andAccount:playerAccount andOpAccount:oponentAccount];
        [self.navigationController popViewControllerAnimated:YES];
    }
    else
        if ([delegate respondsToSelector:@selector(matchStartedTry)]) 
        {
            [delegate matchStartedTry];
        }
}
#pragma  mark -
-(void)loseScene
{
    lastDuel = YES;
    int moneyExch  = playerAccount.money / 10;
    int pointsForMatch=0;
    gameStatusLable.text = @"You lost";
    [self textAnimations];
    [gameStatusLable setTextColor:[UIColor grayColor]];
    lblWinGold.text = [NSString stringWithFormat:@"%@%d", @"$", moneyExch];
    
    [self animationWithLable:lblGold andStartNumber:[AccountDataSource sharedInstance].money andEndNumber:[AccountDataSource sharedInstance].money + 100];
    
    [[NSNotificationCenter defaultCenter] postNotificationName:kAnalyticsTrackEventNotification 
                                                        object:self
                                                      userInfo:[NSDictionary dictionaryWithObject:[NSString stringWithFormat:@"%@%@",stGA,@"final"] forKey:@"event"]];
//    [TestFlight passCheckpoint:[NSString stringWithFormat:@"%@%@",stGA,@"final"]];

    if (!teaching||(duelWithBotCheck)) {
        if(moneyExch< playerAccount.money){
            playerAccount.money -= moneyExch;
        }else{
            playerAccount.money=0;
        }
        oponentAccount.money += moneyExch;
        
        [self increaseLoseCount];
        
        //transaction.trType = [NSNumber numberWithInt:moneyExch / abs(moneyExch)];                       //////////////////transactions
        transaction.trType = [NSNumber numberWithInt:-1];
        transaction.trMoneyCh = [NSNumber numberWithInt:-moneyExch];
        
        for (int i=0; i<[playerAccount.finalInfoTable count]; i++) {
            resoultDataSource = [playerAccount.finalInfoTable objectAtIndex:i];
            if(i==0){
                minUserTime=resoultDataSource.UserTime;
            }else{
                if (minUserTime>resoultDataSource.UserTime) {
                    minUserTime=resoultDataSource.UserTime;
                }
            }
        }
        
        NSLog(@"Oponent Win - User money %d Oponent money %d", playerAccount.money, oponentAccount.money);
        
        pointsForMatch=[self getPointsForLose];        
    }
    
    NSURL *url = [NSURL fileURLWithPath:[NSString stringWithFormat:@"%@/Lose.mp3", [[NSBundle mainBundle] resourcePath]]];
    NSError *error;
    player = [[AVAudioPlayer alloc] initWithContentsOfURL:url error:&error];
    [player play];
    [player setNumberOfLoops:0];
    
    loserImg = [[UIImageView alloc] initWithImage:[UIImage imageNamed:@"fin_img_loser.png"]];
    CGRect frame = loserImg.frame;
    frame.origin.y = 10;
    frame.origin.x = 17;
    loserImg.frame = frame;
    [viewLastSceneAnimation addSubview:loserImg];
    
    [lblLoseEarned setFont: [UIFont fontWithName: @"MyriadPro-Semibold" size:13]];
    [lblLoseLost setFont: [UIFont fontWithName: @"MyriadPro-Semibold" size:13]];
    [lblLoseGold setFont: [UIFont fontWithName: @"MyriadPro-Semibold" size:13]];
    [lblLoseGoldCount setFont: [UIFont fontWithName: @"MyriadPro-Semibold" size:13]];
    [lblLosePoints setFont: [UIFont fontWithName: @"MyriadPro-Semibold" size:13]];
    [lblLosePointsCount setFont: [UIFont fontWithName: @"MyriadPro-Semibold" size:13]];

    lblLoseEarned.text=NSLocalizedString(@"YouEarned", @"");
    lblLoseLost.text=NSLocalizedString(@"YouLost", @"");
    lblLoseGold.text=NSLocalizedString(@"Gold", @"");
    
    NSNumberFormatter *numberFormatter = [[NSNumberFormatter alloc] init];
    [numberFormatter setNumberStyle:NSNumberFormatterDecimalStyle];
    NSString *formattedNumberString = [numberFormatter stringFromNumber:[NSNumber numberWithInt:( playerAccount.money)]];   
    lblLoseGoldCount.text=[NSString stringWithFormat:@"%@",formattedNumberString];
    
    lblLosePointsCount.text=[NSString stringWithFormat:@"%d",pointsForMatch];   
    
    if ([lblLosePointsCount isEqual:@"1"]) {
        lblLosePoints.text=NSLocalizedString(@"Point", @"");
    } else {
        lblLosePoints.text=NSLocalizedString(@"Points", @"");
    }
    [self animationWithLable:lblPoints andStartNumber:[AccountDataSource sharedInstance].accountPoints - pointsForMatch andEndNumber:[AccountDataSource sharedInstance].accountPoints];
    
}

-(void)winScene
{
    lastDuel = YES;
    int moneyExch  = oponentAccount.money / 10;
    int pointsForMatch=0;
    gameStatusLable.text = @"You win";
    [self textAnimations];
    [gameStatusLable setTextColor:[UIColor redColor]];
    lblWinGold.text = [NSString stringWithFormat:@"%@%d", @"$", moneyExch];
    
    [self animationWithLable:lblGold andStartNumber:[AccountDataSource sharedInstance].money andEndNumber:[AccountDataSource sharedInstance].money + moneyExch];
    
    [[NSNotificationCenter defaultCenter] postNotificationName:kAnalyticsTrackEventNotification 
                                                        object:self
                                                      userInfo:[NSDictionary dictionaryWithObject:[NSString stringWithFormat:@"%@%@",stGA,@"final"] forKey:@"event"]];
    if(!teaching||(duelWithBotCheck)){
// added for GC        
            [[GCHelper sharedInstance] reportScore:moneyExch forCategory:GC_LEADEBOARD_MONEY];
// above
        oldMoney=playerAccount.money;
        playerAccount.money += moneyExch;
        oponentAccount.money -= moneyExch;
        
        [self checkMaxWin:moneyExch];

        //transaction.trType = [NSNumber numberWithInt:moneyExch / abs(moneyExch)];                       //////////////////transactions
        transaction.trType = [NSNumber numberWithInt:1];
        transaction.trMoneyCh = [NSNumber numberWithInt:moneyExch];
        
        [[GCHelper sharedInstance] reportScore:playerAccount.money forCategory:GC_LEADEBOARD_MONEY];

        if (![[NSUserDefaults standardUserDefaults] boolForKey:@"dontShowFeedAtFirst"]) {
            [[StartViewController sharedInstance] setShowFeedAtFirst:YES];
        }
        NSLog(@"You Win - User money %d Oponent money %d", playerAccount.money, oponentAccount.money);
        
        [[NSUserDefaults standardUserDefaults] setInteger:playerAccount.money forKey:@"money"];
        
        
        for (int i=0; i<[playerAccount.finalInfoTable count]; i++) {
            resoultDataSource = [playerAccount.finalInfoTable objectAtIndex:i];
            if(i==0){
                minUserTime=resoultDataSource.UserTime;
            }else{
                if (minUserTime>resoultDataSource.UserTime) {
                    minUserTime=resoultDataSource.UserTime;
                }
            }
        }

        [self increaseWinCount];
        
       pointsForMatch=[self getPointsForWin];
    }            
    NSURL *url = [NSURL fileURLWithPath:[NSString stringWithFormat:@"%@/Win.mp3", [[NSBundle mainBundle] resourcePath]]];
    NSError *error;
    player = [[AVAudioPlayer alloc] initWithContentsOfURL:url error:&error];
    [player play];
    [player setNumberOfLoops:0];
    
    winnerImg1 = [[UIImageView alloc] initWithImage:[UIImage imageNamed:@"fin_img_money.png"]];
    CGRect frame = winnerImg1.frame;
    frame.origin.y = 0;
    frame.origin.x = 17;
    winnerImg1.frame = frame;
    [viewLastSceneAnimation addSubview:winnerImg1];
    
    winnerImg2 = [[UIImageView alloc] initWithImage:[UIImage imageNamed:@"fin_img_money2.png"]];
    frame = winnerImg2.frame;
    frame.origin.y = 200;
    frame.origin.x = 17;
    winnerImg2.frame = frame;
    [viewLastSceneAnimation addSubview:winnerImg2];

    UIFont *labelsFont = [UIFont fontWithName: @"MyriadPro-Semibold" size:13];
    [lblWinEarned setFont:labelsFont];
    [lblWinGold setFont:labelsFont];
    [lblWinGoldCount setFont:labelsFont];
    [lblWinPoints setFont:labelsFont];
    [lblWinPointsCount setFont:labelsFont];

    lblWinEarned.text=NSLocalizedString(@"YouEarned", @"");
    lblWinGold.text=NSLocalizedString(@"Gold", @"");
    
    NSNumberFormatter *numberFormatter = [[NSNumberFormatter alloc] init];
    [numberFormatter setNumberStyle:NSNumberFormatterDecimalStyle];
    NSString *formattedNumberString = [numberFormatter stringFromNumber:[NSNumber numberWithInt:( playerAccount.money)]];   
    lblWinGoldCount.text=[NSString stringWithFormat:@"%@",formattedNumberString];
    
    lblWinPointsCount.text=[NSString stringWithFormat:@"%d",pointsForMatch];
    
    if ([lblWinPointsCount isEqual:@"1"]) {
        lblWinPoints.text=NSLocalizedString(@"Point", @"");
    } else {
        lblWinPoints.text=NSLocalizedString(@"Points", @"");
    }
    [self animationWithLable:lblPoints andStartNumber:[AccountDataSource sharedInstance].accountPoints - pointsForMatch andEndNumber:[AccountDataSource sharedInstance].accountPoints];
    
}


-(void)lastScene
{
    [statView setHidden:YES];
    viewLastSceneAnimation.hidden=NO;
    
    [nextButton setHidden:YES];
//    [lbNextRound setHidden:YES];
    [tryButton setHidden:NO];
    [backButton changeTitleByLabel:@"BACK"];
    
    [activityIndicatorView hideView];

    if (!teaching||(duelWithBotCheck)) {
        
        int local = [playerAccount.glNumber intValue];
        local++;
        NSLog(@"number %d", local);
        playerAccount.glNumber = [NSNumber numberWithInt:local];
        //            transaction.trNumber = [NSNumber numberWithInt:local];
        [playerAccount.transactions addObject:transaction];
        
        NSUserDefaults *def = [NSUserDefaults standardUserDefaults];
        
        NSMutableArray *locationData = [[NSMutableArray alloc] init];
        for( CDTransaction *loc in playerAccount.transactions)
        {
            [locationData addObject: [NSKeyedArchiver archivedDataWithRootObject:loc]];
        }
        [def setObject:locationData forKey:@"transactions"];
        
        NSLog(@"Transactions count = %d", [playerAccount.transactions count]);
        [def synchronize];
        
        if (oponentAccount.accountID != nil) duel.dOpponentId = [NSString stringWithString:oponentAccount.accountID];  /////////////////////////////// save duels
        else duel.dOpponentId = @"Anonymous";
        duel.dRateFire = [NSNumber  numberWithInt: userTime];
        duel.dDate = [playerAccount dateFormat];
        duel.dGps = [NSNumber numberWithInt: -1];
        
        NSLog(@"%@ %@ %@ %@", duel.dOpponentId, duel.dRateFire, duel.dDate, duel.dGps);
        
        [playerAccount.duels addObject:duel];
        
        
        NSMutableArray *locationDataDuel = [[NSMutableArray alloc] init];
        for( CDDuel *loc in playerAccount.duels)
        {
            [locationData addObject: [NSKeyedArchiver archivedDataWithRootObject:loc]];
        }
        [def setObject:locationDataDuel forKey:@"duels"];
        
        [def setInteger:playerAccount.money forKey:@"money"];
        
        [def synchronize];
        
        [playerAccount sendTransactions:playerAccount.transactions];
        if([playerAccount.duels count] > 10) 
            [playerAccount sendDuels:playerAccount.duels];
        
        if (fMutchNumberLose != 2) {
            if ((oldMoney<500)&&(playerAccount.money>=500)&&(playerAccount.money<1000)) {
                NSString *moneyText=[NSString stringWithFormat:@"%d",playerAccount.money];
                [self showMessageOfMoreMoney:playerAccount.money withLabel:moneyText];
            }else {
                int thousandOld=oldMoney/1000;
                int thousandNew=playerAccount.money/1000;
                int thousandSecond=(playerAccount.money % 1000)/100;
                if (thousandNew>thousandOld) {
                    if (thousandSecond==0) {
                        [self showMessageOfMoreMoney:playerAccount.money withLabel:[NSString stringWithFormat:@"+%dK",thousandNew]];
                    }else {
                        [self showMessageOfMoreMoney:playerAccount.money withLabel:[NSString stringWithFormat:@"+%d.%dK",thousandNew,thousandSecond]];
                    }
                }
            }
            oldMoney=0;
        }
        
        [[StartViewController sharedInstance] modifierUser];
    }
    
    if (fMutchNumberLose == 2) {
        [self loseAnimation];
    }
    else {
        winnerImg1.hidden = NO;
        winnerImg2.hidden = NO;
        [self winAnimation]; 
    }
    [self.view bringSubviewToFront:activityIndicatorView ];
    
    if (duelWithBotCheck) {
        int randomTime = (arc4random() % 1);
        if (randomTime==0) {
            [self performSelector:@selector(startBotDuelTryAgain) withObject:self afterDelay:5.0];
        }
    }
       if (reachNewLevel) {
        [self showMessageOfNewLevel];
        reachNewLevel=NO;
    }   
<<<<<<< .mine
=======
   // [self showMessageOfNewLevel];
   // [self showMessageOfMoreMoney:playerAccount.money withLabel:@"edrtgyuio"];
>>>>>>> .r573
}

#pragma mark -
#pragma mark Table Data Source Methods
- (NSInteger)numberOfSectionsInTableView:(UITableView *)aTableView 
{ 
	return 1; 
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
	return [playerAccount.finalInfoTable count];
}

-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    UITableViewCellStyle style = UITableViewCellStyleDefault;
    NSString *cellType = @"Default";
    
    ResoultDataSource *rDataSource = [[ResoultDataSource alloc] init];
    rDataSource = [playerAccount.finalInfoTable objectAtIndex:indexPath.row];
    
    UILabel *customText;
    
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:cellType];
    if(!cell)
    {
        cell = [[UITableViewCell alloc]initWithStyle:style reuseIdentifier:cellType];
        [cell.textLabel setFont: [UIFont fontWithName: @"DecreeNarrow" size:21]];
        [cell.textLabel setTextColor:[[UIColor alloc] initWithRed:0.378 green:0.265 blue:0.184 alpha:1]];
        
        customText=[[UILabel alloc] initWithFrame:CGRectMake(tableView.frame.size.width-100, 8, 100,20)];
        [customText setBackgroundColor:[UIColor clearColor]];
        [customText setFont: [UIFont fontWithName: @"DecreeNarrow" size:21]];
        [customText setTextColor:[[UIColor alloc] initWithRed:0.378 green:0.265 blue:0.184 alpha:1]];
        [customText setTextAlignment:UITextAlignmentRight];
        [customText setTag:TAG_TEXT];
        [customText setNumberOfLines:1];
        [cell.contentView addSubview:customText];   

    }else {
        customText=(UILabel*)[cell viewWithTag:TAG_TEXT];
    }
    
    if (fMutchNumberLose == 2) {
        lblResulDescription.text=NSLocalizedString(@"lose", @"");
    }
    else if (fMutchNumberWin == 2){
        lblResulDescription.text=NSLocalizedString(@"win", @"");
    } else
    lblResulDescription.text=[NSString stringWithFormat:@"%@ %d",NSLocalizedString(@"Round", @""),[playerAccount.finalInfoTable count]];
    
    if (rDataSource.result) {
        
        if(!rDataSource.foll){
            cell.imageView.image = [UIImage imageNamed:@"fin_img_table_win_new.png"];
            cell.textLabel.text = [NSString stringWithFormat:@"%d.%d", abs(rDataSource.deltaTime / 1000), abs(rDataSource.deltaTime % 1000)];
            
            NSString *text=NSLocalizedString(@"win", @"");
            customText.text=[text uppercaseString];
//            [cell.textLabel setFont: [UIFont fontWithName: @"DecreeNarrow" size:30]];
//            [cell.textLabel setTextColor:[[UIColor alloc] initWithRed:0.317 green:0.274 blue:0.184 alpha:1]];
        }else{
            cell.imageView.image = [UIImage imageNamed:@"fin_img_table_lose_new.png"];
            cell.textLabel.text = NSLocalizedString(@"False", @"");
            
            NSString *text=NSLocalizedString(@"You lost", @"");
            customText.text=[text uppercaseString];
//            [cell.textLabel setFont: [UIFont fontWithName: @"DecreeNarrow" size:30]];
//            [cell.textLabel setTextColor:[[UIColor alloc] initWithRed:0.317 green:0.274 blue:0.184 alpha:1]];
        }
    }
    if (!rDataSource.result) {
        if(!rDataSource.foll){
            cell.imageView.image = [UIImage imageNamed:@"fin_img_table_lose_new.png"];
            cell.textLabel.text = [NSString stringWithFormat:@"%d.%d", abs(rDataSource.deltaTime / 1000), abs(rDataSource.deltaTime % 1000)];
            
            NSString *text=NSLocalizedString(@"You lost", @"");
            customText.text=[text uppercaseString];
//            [cell.textLabel setFont: [UIFont fontWithName: @"DecreeNarrow" size:30]];
//            [cell.textLabel setTextColor:[[UIColor alloc] initWithRed:0.317 green:0.274 blue:0.184 alpha:1]];
        }else{
            cell.imageView.image = [UIImage imageNamed:@"fin_img_table_win_new.png"];
            cell.textLabel.text = NSLocalizedString(@"Falses", @"");
            
            NSString *text=NSLocalizedString(@"win", @"");
            customText.text=[text uppercaseString];
//            [cell.textLabel setFont: [UIFont fontWithName: @"DecreeNarrow" size:30]];
//            [cell.textLabel setTextColor:[[UIColor alloc] initWithRed:0.317 green:0.274 blue:0.184 alpha:1]];
        }
        
    }
    [cell.textLabel.text uppercaseString];
    
    NSInteger sectionRows = [tableView numberOfRowsInSection:[indexPath section]];
	NSInteger row = [indexPath row];
    NSLog(@"sectionRows %d row %d",sectionRows,row);
    if (runAway && (row == (sectionRows-1))){
        if (runAwayGood) {
            cell.imageView.image = [UIImage imageNamed:@"fin_img_table_win_new.png"];
            cell.textLabel.text = NSLocalizedString(@"TB_RUN_AWAY_GOOD", @"");
          
            NSString *text=NSLocalizedString(@"win", @"");
            customText.text=[text uppercaseString];

        }else{
            cell.imageView.image = [UIImage imageNamed:@"fin_img_table_lose_new.png"];
            cell.textLabel.text = NSLocalizedString(@"TB_RUN_AWAY", @"");
        }
    }
    
    cell.selectionStyle = UITableViewCellSelectionStyleNone;
    
    
    return cell;
}

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    return 36; // your dynamic height...
}

#pragma mark -

-(void)winAnimation
{
    winnerImg2.alpha = 0.0;
    [UIView beginAnimations:nil context:nil];
    [UIView setAnimationBeginsFromCurrentState:YES]; 
	[UIView setAnimationCurve:UIViewAnimationCurveLinear];
    [UIView setAnimationDuration:1.2f];
	[UIView setAnimationDelegate:self];
    [UIView setAnimationDidStopSelector:@selector(showMoney)];
    CGRect frame = winnerImg1.frame;
    frame.origin.y += 200;
    winnerImg1.frame = frame;
    [UIView commitAnimations];
    
    
}
-(void)showMoney
{
    winnerImg2.alpha = 1.0;
    [self showMoneyLable];
}

-(void)loseAnimation
{
    loserImg.hidden = NO;

    [UIView beginAnimations:nil context:nil];
    [UIView setAnimationBeginsFromCurrentState:YES]; 
	[UIView setAnimationCurve:UIViewAnimationCurveLinear];
    [UIView setAnimationDuration:1.2f];
	[UIView setAnimationDelegate:self];
    CGRect frame = loserImg.frame;
    frame.origin.y += 200;
    loserImg.frame = frame;
    
    [UIView setAnimationDidStopSelector:@selector(showMoneyLable)];
    [UIView commitAnimations];
}

-(void)showMoneyLable
{
    if (fMutchNumberLose == 2) {
        lblResulDescription.text=NSLocalizedString(@"lose", @"");
        [viewLose setHidden:NO];
    }
    else {
        lblResulDescription.text=NSLocalizedString(@"win", @"");
        [viewWin setHidden:NO]; 
    }
}

#pragma mark - check Level, Points change and other saved features

-(NSInteger)getPointsForWin;
{
    NSInteger oldL=playerAccount.accountPoints;
    int winPonits=[DuelRewardLogicController getPointsForWinWithOponentLevel:oponentAccount.accountLevel];
    playerAccount.accountPoints+=winPonits;
    [[NSUserDefaults standardUserDefaults] setInteger:playerAccount.accountPoints forKey:@"lvlPoints"];

    [self compareNewLevel:playerAccount.accountPoints withOldLevel:oldL];
    
    return winPonits;
}

-(NSInteger)getPointsForLose;
{
    NSInteger oldL=playerAccount.accountPoints;
    int losePonits=[DuelRewardLogicController getPointsForLoseWithOponentLevel:oponentAccount.accountLevel];
    playerAccount.accountPoints+=losePonits;
    [[NSUserDefaults standardUserDefaults] setInteger:playerAccount.accountPoints forKey:@"lvlPoints"];
    
    [self compareNewLevel:playerAccount.accountPoints withOldLevel:oldL];
    
    return losePonits;
}

-(void)compareNewLevel:(NSInteger)newL withOldLevel:(NSInteger) oldL;
{
    _pointForEachLevels=[DuelRewardLogicController getStaticPointsForEachLevels];

    for ( NSNumber *pointMoney in _pointForEachLevels) {
        if (([pointMoney intValue]<=newL)&&([pointMoney intValue]>oldL)) {
            int playerNewLevel=[_pointForEachLevels indexOfObject:pointMoney] + 2;
            
            playerAccount.accountLevel=playerNewLevel;
            [[NSUserDefaults standardUserDefaults] setInteger:playerAccount.accountLevel forKey:@"accountLevel"];
            
            reachNewLevel=YES;
            
            [[GCHelper sharedInstance] reportAchievementIdentifier:[[GCHelper sharedInstance].GC_ACH objectAtIndex:playerAccount.accountLevel-1] percentComplete:100.0f];
            [[NSUserDefaults standardUserDefaults] synchronize];
            
            break;
        }
    }
}

#pragma mark -

-(void)showMessageOfNewLevel
{
    lvlCongratulationViewController=[[LevelCongratViewController alloc] initForNewLevelPlayerAccount:playerAccount andController:self];
    [self performSelector:@selector(showViewController:) withObject:lvlCongratulationViewController afterDelay:5.0];
    //[self.navigationController  pushViewController:lvlCongratulationViewController animated:YES];
}

-(void)showMessageOfMoreMoney:(NSInteger)money withLabel:(NSString *)labelForCongratulation
{
    moneyCongratulationViewController  = [[MoneyCongratViewController alloc] initForAchivmentPlayerAccount:playerAccount withLabel:labelForCongratulation andController:self];
    [self performSelector:@selector(showViewController:) withObject:moneyCongratulationViewController afterDelay:5.0];
    //[self.navigationController  pushViewController:moneyCongratulationViewController animated:YES];
}

#pragma mark -

-(void)checkMaxWin:(int)moneyExch;
{
    NSUserDefaults *udef = [NSUserDefaults standardUserDefaults];
    if (playerAccount.accountBigestWin==0){
        playerAccount.accountBigestWin=moneyExch;
    }
    else
    {
        if (moneyExch>playerAccount.accountBigestWin) {
            playerAccount.accountBigestWin=moneyExch;
        }
    }
    [udef setInteger:playerAccount.accountBigestWin forKey:@"MaxWin"];
    [udef synchronize];
}

-(void)increaseLoseCount;
{
    NSUserDefaults *udef = [NSUserDefaults standardUserDefaults];
    if (playerAccount.accountDraws==0){
        playerAccount.accountDraws=1;
    }
    else
    {
        playerAccount.accountDraws++;
    }
    [udef setInteger:playerAccount.accountDraws forKey:@"DrawCount"];
    [udef synchronize];
}

-(void)increaseWinCount;

{
    if ( playerAccount.accountWins==0){
        playerAccount.accountWins=1;
    }
    else
    {
         playerAccount.accountWins++;
    }
    [[NSUserDefaults standardUserDefaults] setInteger:playerAccount.accountWins forKey:@"WinCount"];
    [[NSUserDefaults standardUserDefaults] synchronize];
}

#pragma mark -

-(void)startBotDuelTryAgain
{
    NSLog(@"Eshe Raz");
    [playerAccount.finalInfoTable removeAllObjects];
    DuelStartViewController  *tempVC=(DuelStartViewController*)[self.navigationController.viewControllers objectAtIndex:2] ;
    [tempVC setMessageTry];
    [tempVC setUserMoney:playerAccount.money];
    [tempVC setOponentMoney:oponentAccount.money];
    [self.navigationController popToViewController:tempVC animated:YES];
}


- (void)viewDidUnload {
    statView = nil;
    lblWinEarned = nil;
    lblWinGold = nil;
    lblWinGoldCount = nil;
    lblWinPoints = nil;
    lblWinPointsCount = nil;
    viewLose = nil;
    lblLoseEarned = nil;
    lblLoseGold = nil;
    lblLoseGoldCount = nil;
    lblLosePoints = nil;
    lblLosePointsCount = nil;
    lblLoseLost = nil;
    lbBack = nil;
    lbTryAgain = nil;
    lbNextRound = nil;
    lblGold = nil;
    gameStatusLable = nil;
    lblPoints = nil;
    [super viewDidUnload];
}

-(void)animationWithLable:(UILabel *)lable andStartNumber:(int)startNumber andEndNumber:(int)endNumber
{
    dispatch_async(dispatch_queue_create([lable.text cStringUsingEncoding:NSUTF8StringEncoding], NULL), ^{
        float goldForGoldAnimation;
        if (endNumber - startNumber < 200) {
            goldForGoldAnimation = 1;
        }else {
            goldForGoldAnimation = (endNumber - startNumber)/200;
        }
        for (int i = startNumber; i <= endNumber; i += goldForGoldAnimation) {
            dispatch_async(dispatch_get_main_queue(), ^{
                
                lable.text = [NSString stringWithFormat:@"%d", i];
            });
            
            [NSThread sleepForTimeInterval:0.02];
            
            
        }
        dispatch_async(dispatch_get_main_queue(), ^{
            lable.text = [NSString stringWithFormat:@"%d", endNumber];
        });
    });
    
}

-(void)textAnimations
{
    __block NSMutableString *str = [gameStatusLable.text mutableCopy];
    [str insertString:@"                         " atIndex:4];
    gameStatusLable.text = str;
    NSRange range;
    range.length = 1;
    range.location = 4;
    dispatch_async(dispatch_queue_create("text animation", NULL), ^{
        for (int i = 1; i <= 25; i ++) {
            dispatch_async(dispatch_get_main_queue(), ^{
                
                [str replaceCharactersInRange:range withString:@""];
                gameStatusLable.text = str;
            });
            
            [NSThread sleepForTimeInterval:0.05];
            
            
        }
        
    });

    
}

-(void)showViewController:(UIViewController *)viewController
{
    [self presentModalViewController:viewController animated:YES];
}


@end
